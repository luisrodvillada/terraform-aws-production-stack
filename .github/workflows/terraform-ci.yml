name: Terraform CI

# üëâ Este workflow se ejecuta autom√°ticamente
#    cuando hay cambios en el repo
on:
    pull_request:
    push:
        branches:
            - main

jobs:
    terraform-ci:
        name: Terraform Validation
        runs-on: ubuntu-latest

        # üëâ Matrix para ejecutar el CI en varios entornos
        #    (mismo c√≥digo, distinto contexto)
        strategy:
            matrix:
                env: [dev, prod]

        defaults:
            run:
                shell: bash

        steps:
            # 1Ô∏è‚É£ Descargar el c√≥digo del repo
            - name: Checkout repository
              uses: actions/checkout@v4

            # 2Ô∏è‚É£ Instalar Terraform en el runner
            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3

            # 3Ô∏è‚É£ Inicializar Terraform (backend + m√≥dulos)
            - name: Terraform Init
              run: terraform init -input=false
              working-directory: envs/${{ matrix.env }}

            # 4Ô∏è‚É£ Formatear c√≥digo (estilo est√°ndar)
            # ‚ùå Falla si alguien no ejecut√≥ terraform fmt
            - name: Terraform Format Check
              run: terraform fmt -check -recursive
              working-directory: envs/${{ matrix.env }}

            # 5Ô∏è‚É£ Validar sintaxis y referencias
            - name: Terraform Validate
              run: terraform validate
              working-directory: envs/${{ matrix.env }}

            # 6Ô∏è‚É£ Calcular cambios SIN aplicarlos
            - name: Terraform Plan
              run: terraform plan -input=false
              working-directory: envs/${{ matrix.env }}
